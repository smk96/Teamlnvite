<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Team ç®¡ç†åå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10a37f;
            --primary-hover: #1a7f64;
            --secondary: #6e6e80;
            --danger: #ef4146;
            --bg-color: #f7f7f8;
            --card-bg: #ffffff;
            --text-main: #202123;
            --text-secondary: #6e6e80;
            --border-color: #e5e5e5;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            line-height: 1.5;
            padding: 20px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 { 
            font-size: 24px; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Form Elements */
        .form-group { margin-bottom: 16px; }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-secondary);
        }

        input[type="text"], 
        input[type="email"], 
        input[type="number"], 
        textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            font-size: 14px; 
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus, textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        textarea { min-height: 100px; resize: vertical; font-family: monospace; font-size: 13px; }

        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: var(--radius-md); 
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
        
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-danger:hover { background: #fecaca; }
        
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        /* Teams Grid */
        .teams-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); 
            gap: 20px; 
        }

        .team-card { 
            background: #fff;
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-lg); 
            padding: 20px; 
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .team-card:hover { 
            border-color: var(--primary); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }

        .team-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
        }

        .team-header h3 { font-size: 16px; font-weight: 600; }
        .team-title { display: flex; align-items: center; gap: 8px; }
        .team-title .btn { padding: 4px 8px; }

        .team-info { margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); }
        .team-info p { margin-bottom: 4px; display: flex; justify-content: space-between;}
        
        .team-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-top: 16px;
            border-top: 1px dashed var(--border-color);
        }

        .badge { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 99px; 
            font-size: 12px; 
            font-weight: 500; 
            background: #f1f5f9;
            color: #475569;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef9c3; color: #854d0e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .token-reminder {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            color: #9a3412;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            margin-bottom: 12px;
        }
        .token-reminder strong { font-weight: 600; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
        .modal-content { 
            background-color: white; 
            margin: 5% auto; 
            padding: 0; 
            border-radius: var(--radius-lg); 
            width: 90%; 
            max-width: 700px; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .modal-header { 
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-header h2 { font-size: 18px; font-weight: 600; margin: 0; }
        
        .close { color: #9ca3af; font-size: 24px; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: var(--text-main); }
        
        .modal-body { padding: 24px; }

        .member-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .member-item:last-child { border-bottom: none; }
        
        .member-info strong { display: block; font-size: 14px; color: var(--text-main); }
        .member-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

        code { 
            background: #f1f5f9; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'Menlo', monospace; 
            font-size: 12px; 
            color: #0f172a;
        }
        
        .key-code { cursor: pointer; }
        .key-code:hover { background: #e2e8f0; }

        /* Checkbox wrapper */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-wrapper input { width: 16px; height: 16px; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card, .team-card { animation: fadeIn 0.4s ease-out; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-layer-group" style="color: var(--primary);"></i> ChatGPT Team Manager</h1>
            <div style="font-size: 14px; color: var(--text-secondary);">Deno Edition</div>
        </div>

        <div class="grid-layout">
            <!-- æ·»åŠ  Team -->
            <div class="card">
                <h2><i class="fa-solid fa-plus-circle"></i> æ·»åŠ æ–° Team</h2>
                <form id="addTeamForm" onsubmit="addTeam(event)">
                    <div class="form-group">
                        <label>Team åç§°</label>
                        <input type="text" name="name" required placeholder="ä¾‹å¦‚: Team Alpha">
                    </div>
                    <div class="form-group">
                        <label>Session JSON</label>
                        <textarea name="session_data" id="sessionDataInput" required placeholder='{"user": {...}, "accessToken": "..."}'></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fa-solid fa-check"></i> æ·»åŠ  Team</button>
                        <button type="button" onclick="getAccountCheckoutLink()" class="btn btn-secondary"><i class="fa-solid fa-link"></i> è·å–è´¦å•é“¾æ¥</button>
                    </div>
                </form>
            </div>

            <!-- Auto-Kick é…ç½® -->
            <div class="card">
                <h2><i class="fa-solid fa-robot"></i> è‡ªåŠ¨åŒ–é…ç½®</h2>
                <form id="autoKickConfigForm" onsubmit="saveAutoKickConfig(event)">
                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="auto_kick_enabled" name="enabled">
                            <span>å¯ç”¨è‡ªåŠ¨è¸¢äºº</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>æ£€æµ‹é—´éš” (ç§’)</label>
                        <input type="number" id="check_interval" name="check_interval" value="300" min="60">
                    </div>
                    <div class="form-group">
                        <label>è¿è¡Œæ—¶é—´æ®µ (åŒ—äº¬æ—¶é—´)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="start_hour" name="start_hour" value="0" min="0" max="23">
                            <span style="color: var(--text-secondary); white-space: nowrap;">è‡³</span>
                            <input type="number" id="end_hour" name="end_hour" value="23" min="0" max="23">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;"><i class="fa-solid fa-save"></i> ä¿å­˜é…ç½®</button>
                </form>
            </div>
            
            <!-- é‚€è¯·ç ç®¡ç† -->
            <div class="card full-width">
                <h2><i class="fa-solid fa-key"></i> é‚€è¯·ç ç®¡ç†</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: flex-end;">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div class="form-group" style="margin: 0; width: 120px;">
                            <label>ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="key_count" name="count" value="1" min="1" max="50">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="createKeys(false)">
                            <i class="fa-solid fa-ticket"></i> ç”Ÿæˆä¸€æ¬¡æ€§ç 
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="createKeys(true)">
                            <i class="fa-solid fa-infinity"></i> ç”Ÿæˆæ— é™ç 
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openNormalKeysModal()" class="btn btn-secondary">
                            <i class="fa-solid fa-list"></i> æŸ¥çœ‹ä¸€æ¬¡æ€§ç 
                        </button>
                        <button onclick="openUnlimitedKeysModal()" class="btn btn-secondary">
                            <i class="fa-solid fa-list-check"></i> æŸ¥çœ‹æ— é™ç 
                        </button>
                    </div>
                </div>
            </div>

            <!-- Teams åˆ—è¡¨ -->
            <div class="card full-width">
                <h2>
                    <i class="fa-solid fa-users"></i> Teams åˆ—è¡¨
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button onclick="exportTeamsTxt()" class="btn btn-sm btn-secondary">
                            <i class="fa-regular fa-file-lines"></i> å¯¼å‡º TXT
                        </button>
                        <button onclick="toggleTeamsList()" class="btn btn-sm btn-secondary" id="toggleTeamsBtn">
                            <i class="fa-regular fa-eye"></i> åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                </h2>
                <div id="tokenReminder" class="token-reminder" style="display: none;"></div>
                <div id="teamsList" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="teamModalTitle">ğŸ‘¥ Team æˆå‘˜</h2>
                <span class="close" onclick="closeTeamModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 14px; color: var(--text-secondary); margin: 0;">æˆå‘˜åˆ—è¡¨</h3>
                    <button onclick="openInviteModal()" class="btn btn-primary btn-sm" style="padding: 4px 10px; font-size: 12px;">
                        <i class="fa-solid fa-paper-plane"></i> ç›´æ¥é‚€è¯·
                    </button>
                </div>
                <div id="membersList" style="background: #f8fafc; border-radius: 8px; border: 1px solid var(--border-color);">åŠ è½½ä¸­...</div>
                
                <h3 style="font-size: 14px; color: var(--text-secondary); margin: 24px 0 12px;">å¾…æ¥å—é‚€è¯·</h3>
                <div id="pendingInvitesList" style="background: #f8fafc; border-radius: 8px; border: 1px solid var(--border-color);">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="normalKeysModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”‘ ä¸€æ¬¡æ€§é‚€è¯·ç </h2>
                <span class="close" onclick="closeKeysModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary btn-sm" onclick="copyKeys(false)"><i class="fa-regular fa-copy"></i> å¤åˆ¶å…¨éƒ¨</button>
                </div>
                <div id="normalKeysList" style="max-height: 400px; overflow-y: auto;">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="unlimitedKeysModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â™¾ï¸ æ— é™é‚€è¯·ç </h2>
                <span class="close" onclick="closeKeysModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary btn-sm" onclick="copyKeys(true)"><i class="fa-regular fa-copy"></i> å¤åˆ¶å…¨éƒ¨</button>
                </div>
                <div id="unlimitedKeysList">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸ”— ä»˜æ¬¾é“¾æ¥</h2>
                <span class="close" onclick="closeCheckoutModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Generated Link</label>
                    <input type="text" id="checkoutLinkInput" readonly onclick="this.select()">
                </div>
                <button class="btn btn-primary" onclick="copyCheckoutLink()" style="width: 100%;"><i class="fa-regular fa-copy"></i> å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-paper-plane"></i> é‚€è¯·æ–°æˆå‘˜</h2>
                <span class="close" onclick="closeInviteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="submitInvite(event)">
                    <div class="form-group">
                        <label>é‚®ç®±åœ°å€ (å¤šä¸ªé‚®ç®±è¯·ç”¨é€—å·åˆ†éš”)</label>
                        <textarea id="inviteEmailInput" required placeholder="name@example.com, other@example.com" style="width: 100%; min-height: 80px;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">å‘é€é‚€è¯·</button>
                </form>
            </div>
        </div>
    </div>

    <div id="updateTokenModal" class="modal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-arrows-rotate"></i> æ›´æ–° Team Token</h2>
                <span class="close" onclick="closeUpdateTokenModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Team åç§°</label>
                    <input type="text" id="updateTokenTeamName" readonly>
                </div>
                <div class="form-group">
                    <label>Session JSON</label>
                    <textarea id="updateTokenSessionInput" placeholder='{"user": {...}, "accessToken": "..."}' style="width: 100%; min-height: 140px;"></textarea>
                    <div class="member-meta" style="margin-top: 6px;">æç¤ºï¼šToken é€šå¸¸ 3-7 å¤©å¤±æ•ˆï¼Œå»ºè®®æ¯ 3-5 å¤©æ‰‹åŠ¨æ›´æ–°ã€‚</div>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitUpdateToken()" style="width: 100%;">ä¿å­˜ Token</button>
            </div>
        </div>
    </div>

    <script>
        let allKeys = [];
        let teamsLoaded = false;
        let keysLoaded = false;
        let currentTeamId = null;
        let currentTeamName = "";
        let updatingTeamId = null;
        let updatingTeamName = "";
        const TOKEN_REFRESH_DAYS = 5;

        window.onload = function () {
            loadAutoKickConfig();
            loadTeams(); // Auto load teams on start for better UX
            teamsLoaded = true;
            document.getElementById('teamsList').style.display = 'block';
        };

        async function openNormalKeysModal() { await openKeysModal(false); }
        async function openUnlimitedKeysModal() { await openKeysModal(true); }

        async function openKeysModal(isUnlimited) {
            if (!keysLoaded) {
                await loadKeys();
                keysLoaded = true;
            } else {
                renderKeysList(isUnlimited);
            }
            const modalId = isUnlimited ? 'unlimitedKeysModal' : 'normalKeysModal';
            document.getElementById(modalId).style.display = 'block';
        }

        function toggleTeamsList() {
            const teamsList = document.getElementById('teamsList');
            const toggleBtn = document.getElementById('toggleTeamsBtn');
            // Always refresh
            loadTeams();
            teamsList.style.display = 'block';
        }

        async function addTeam(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ·»åŠ ä¸­...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            try {
                const response = await fetch('/api/admin/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        session_data: formData.get('session_data')
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Team æ·»åŠ æˆåŠŸï¼');
                    e.target.reset();
                    loadTeams();
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadKeys() {
            try {
                const response = await fetch('/api/admin/keys');
                const data = await response.json();
                if (data.success) {
                    allKeys = data.keys;
                    refreshKeyModals();
                }
            } catch (error) {
                console.error('åŠ è½½é‚€è¯·ç å¤±è´¥:', error);
            }
        }

        function refreshKeyModals() {
            const normalModal = document.getElementById('normalKeysModal');
            const unlimitedModal = document.getElementById('unlimitedKeysModal');
            if (normalModal.style.display === 'block') renderKeysList(false);
            if (unlimitedModal.style.display === 'block') renderKeysList(true);
        }

        function renderKeysList(isUnlimited) {
            const container = document.getElementById(isUnlimited ? 'unlimitedKeysList' : 'normalKeysList');
            const keys = allKeys.filter(k => !!k.isUnlimited === isUnlimited);

            if (!keys || keys.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— é‚€è¯·ç </p>';
                return;
            }

            let html = '<div class="keys-list">';
            keys.forEach(key => {
                const keyCode = key.code;
                const usedBadge = isUnlimited
                    ? `<span class="badge badge-warning">å·²ç”¨ ${key.usageCount} æ¬¡</span>`
                    : (key.usageCount > 0 ? '<span class="badge badge-danger">å·²å¤±æ•ˆ</span>' : '<span class="badge badge-success">æœ‰æ•ˆ</span>');

                html += `
                    <div class="member-item">
                        <div class="member-info">
                            <code class="key-code" onclick="copyKey('${keyCode}')">${keyCode}</code>
                            <div class="member-meta">
                                ${usedBadge}
                                ${key.isTemp ? '<span class="badge">ä¸´æ—¶</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-danger btn-sm" onclick="deleteKey('${keyCode}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function createKeys(isUnlimited) {
            const count = parseInt(document.getElementById('key_count').value) || 1;
            try {
                const response = await fetch('/api/admin/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: count, is_unlimited: !!isUnlimited })
                });
                const data = await response.json();
                if (data.success) {
                    await loadKeys();
                    if(isUnlimited) openUnlimitedKeysModal();
                    else openNormalKeysModal();
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function loadAutoKickConfig() {
            try {
                const response = await fetch('/api/admin/auto-kick/config');
                const data = await response.json();
                if (data.success && data.config) {
                    document.getElementById('auto_kick_enabled').checked = data.config.enabled;
                    document.getElementById('check_interval').value = data.config.check_interval;
                    document.getElementById('start_hour').value = data.config.start_hour;
                    document.getElementById('end_hour').value = data.config.end_hour;
                }
            } catch (error) { console.error('åŠ è½½é…ç½®å¤±è´¥:', error); }
        }

        async function saveAutoKickConfig(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';

            const config = {
                enabled: document.getElementById('auto_kick_enabled').checked,
                check_interval: parseInt(document.getElementById('check_interval').value),
                start_hour: parseInt(document.getElementById('start_hour').value),
                end_hour: parseInt(document.getElementById('end_hour').value)
            };
            try {
                const response = await fetch('/api/admin/auto-kick/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                if (data.success) {
                    // visual feedback
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²ä¿å­˜';
                    setTimeout(() => btn.innerHTML = originalText, 2000);
                }
                else alert('é”™è¯¯: ' + data.error);
            } catch (error) { alert('è¯·æ±‚å¤±è´¥: ' + error.message); }
        }

        async function loadTeams() {
            const container = document.getElementById('teamsList');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;"><i class="fa-solid fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch('/api/admin/teams');
                const data = await response.json();
                if (data.success) displayTeams(data.teams);
            } catch (error) { console.error('åŠ è½½ Teams å¤±è´¥:', error); }
        }

        function formatDateTime(value) {
            if (!value) return '-';
            const date = new Date(value);
            return isNaN(date.getTime()) ? '-' : date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function addDays(ts, days) {
            if (!ts) return null;
            const date = new Date(ts);
            if (isNaN(date.getTime())) return null;
            date.setDate(date.getDate() + days);
            return date.getTime();
        }

        function displayTeams(teams) {
            const container = document.getElementById('teamsList');
            const reminder = document.getElementById('tokenReminder');
            if (teams.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">æš‚æ—  Team</p>';
                if (reminder) reminder.style.display = 'none';
                return;
            }
            let html = '<div class="teams-grid">';
            let expiredCount = 0;
            let refreshCount = 0;
            teams.forEach(team => {
                const createdAt = team.createdAt || team.created_at || team.created;
                const expiresAt = addDays(createdAt, 30);
                const rangeText = `${formatDateTime(createdAt)} - ${formatDateTime(expiresAt)}`;
                const isExpired = team.tokenStatus === 'expired';
                const tokenUpdatedAt = team.tokenUpdatedAt || team.updatedAt || team.createdAt;
                const tokenAgeDays = tokenUpdatedAt ? Math.floor((Date.now() - tokenUpdatedAt) / 86400000) : null;
                const tokenAgeText = tokenUpdatedAt ? `${formatDateTime(tokenUpdatedAt)} (${tokenAgeDays}å¤©å‰)` : '-';
                const tokenNeedsRefresh = tokenAgeDays === null || tokenAgeDays >= TOKEN_REFRESH_DAYS;
                const tokenBadgeClass = isExpired ? 'badge-danger' : (tokenNeedsRefresh ? 'badge-warning' : 'badge-success');
                const tokenBadgeText = isExpired ? 'å·²è¿‡æœŸ' : (tokenNeedsRefresh ? 'å»ºè®®æ›´æ–°' : 'æ­£å¸¸');

                if (isExpired) expiredCount++;
                else if (tokenNeedsRefresh) refreshCount++;

                html += `
                    <div class="team-card" style="${isExpired ? 'border-color:var(--danger); background:#fff5f5;' : ''}">
                        <div class="team-header">
                            <div class="team-title">
                                <h3>${team.name}</h3>
                                <button class="btn btn-secondary btn-sm" onclick="renameTeam('${team.id}', '${team.name}')" title="ä¿®æ”¹åç§°">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                            <button type="button" class="badge" onclick="showTeamModal('${team.id}', '${team.name}')">${team.memberCount || 0}/4</button>
                        </div>
                        <div class="team-info">
                            <p><span>ID</span> <code>${team.accountId.substring(0, 18)}...</code></p>
                            <p><span>çŠ¶æ€</span> <span class="badge ${isExpired ? 'badge-danger' : 'badge-success'}">${team.tokenStatus}</span></p>
                            <p><span>Tokenæ›´æ–°</span> <span>${tokenAgeText}</span></p>
                            <p><span>Tokenæç¤º</span> <span class="badge ${tokenBadgeClass}">${tokenBadgeText}</span></p>
                            <p><span>æœ‰æ•ˆæœŸ</span> <span>${rangeText}</span></p>
                        </div>
                        <div class="team-actions">
                            <button onclick="showTeamModal('${team.id}', '${team.name}')" class="btn btn-secondary btn-sm" style="flex:1"><i class="fa-solid fa-users-gear"></i> ç®¡ç†</button>
                            <button onclick="openUpdateTokenModal('${team.id}', '${team.name}')" class="btn btn-secondary btn-sm"><i class="fa-solid fa-arrows-rotate"></i> æ›´æ–°Token</button>
                            <button onclick="deleteTeam('${team.id}')" class="btn btn-danger btn-sm"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;

            if (reminder) {
                if (expiredCount > 0 || refreshCount > 0) {
                    reminder.style.display = 'block';
                    reminder.innerHTML = `<strong>Token æé†’</strong>ï¼š${expiredCount} ä¸ªå·²è¿‡æœŸï¼Œ${refreshCount} ä¸ªè¶…è¿‡ ${TOKEN_REFRESH_DAYS} å¤©æœªæ›´æ–°ã€‚è¯·ç‚¹å‡»â€œæ›´æ–°Tokenâ€æ‰‹åŠ¨åˆ·æ–°ã€‚`;
                } else {
                    reminder.style.display = 'none';
                }
            }
        }

        async function deleteTeam(teamId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/admin/teams/${teamId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) { loadTeams(); }
                else alert('é”™è¯¯: ' + data.error);
            } catch (error) { alert('è¯·æ±‚å¤±è´¥: ' + error.message); }
        }

        async function renameTeam(teamId, currentName) {
            const name = prompt('è¯·è¾“å…¥æ–°çš„ Team åç§°', currentName || '');
            if (!name) return;
            const trimmed = name.trim();
            if (!trimmed || trimmed === currentName) return;
            try {
                const response = await fetch(`/api/admin/teams/${teamId}/name`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: trimmed })
                });
                const data = await response.json();
                if (data.success) {
                    loadTeams();
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        function closeTeamModal() { document.getElementById('teamModal').style.display = 'none'; }
        function closeKeysModal() {
            document.getElementById('normalKeysModal').style.display = 'none';
            document.getElementById('unlimitedKeysModal').style.display = 'none';
            document.getElementById('inviteModal').style.display = 'none';
        }

        async function showTeamModal(teamId, teamName) {
            currentTeamId = teamId;
            currentTeamName = teamName;
            document.getElementById('teamModalTitle').textContent = `ğŸ‘¥ ${teamName}`;
            document.getElementById('teamModal').style.display = 'block';
            await loadMembers(teamId);
            await loadPendingInvites(teamId);
        }

        function openUpdateTokenModal(teamId, teamName) {
            updatingTeamId = teamId;
            updatingTeamName = teamName || '';
            document.getElementById('updateTokenTeamName').value = updatingTeamName;
            document.getElementById('updateTokenSessionInput').value = '';
            document.getElementById('updateTokenModal').style.display = 'block';
            setTimeout(() => document.getElementById('updateTokenSessionInput').focus(), 100);
        }

        function closeUpdateTokenModal() {
            document.getElementById('updateTokenModal').style.display = 'none';
        }

        async function submitUpdateToken() {
            if (!updatingTeamId) return;
            const sessionData = document.getElementById('updateTokenSessionInput').value.trim();
            if (!sessionData) {
                alert('è¯·ç²˜è´´ Session JSON');
                return;
            }
            try {
                const response = await fetch(`/api/admin/teams/${updatingTeamId}/token`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_data: sessionData })
                });
                const data = await response.json();
                if (data.success) {
                    closeUpdateTokenModal();
                    loadTeams();
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        function openInviteModal() {
            document.getElementById('inviteEmailInput').value = '';
            document.getElementById('inviteModal').style.display = 'block';
            setTimeout(() => document.getElementById('inviteEmailInput').focus(), 100);
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
        }

        function parseJsonSafe(text) {
            if (!text) return null;
            try {
                return JSON.parse(text);
            } catch {
                return null;
            }
        }

        async function submitInvite(e) {
            e.preventDefault();
            const emailInput = document.getElementById('inviteEmailInput');
            const rawEmails = emailInput.value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            
            if (!rawEmails) return;

            // Split by comma, trim whitespace, and filter empty strings
            const emails = rawEmails.split(/[,ï¼Œ\n]/).map(e => e.trim()).filter(e => e);

            if (emails.length === 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€");
                return;
            }

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å‘é€ä¸­...';
            btn.disabled = true;

            let successCount = 0;
            let failCount = 0;
            let errors = [];

            try {
                // Prefer batch API
                const batchRes = await fetch(`/api/admin/teams/${currentTeamId}/invites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails })
                });

                if (batchRes.status !== 404) {
                    const text = await batchRes.text();
                    const data = parseJsonSafe(text);
                    const ok = data ? !!data.success : batchRes.ok;

                    if (data?.results && Array.isArray(data.results)) {
                        data.results.forEach(r => {
                            if (r.success) successCount++;
                            else {
                                failCount++;
                                errors.push(`${r.email}: ${r.error || 'Invite failed'}`);
                            }
                        });
                    } else if (ok) {
                        successCount = emails.length;
                    } else {
                        failCount = emails.length;
                        errors = emails.map(e => `${e}: ${data?.error || (text || `HTTP ${batchRes.status}`)}`);
                    }
                } else {
                    // Fallback to single-invite API for older deployments
                    const promises = emails.map(email =>
                        fetch(`/api/admin/teams/${currentTeamId}/invite`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        }).then(async res => {
                            const text = await res.text();
                            const data = parseJsonSafe(text);
                            const ok = data ? !!data.success : res.ok;

                            if (ok) {
                                successCount++;
                            } else {
                                failCount++;
                                const errMsg = data?.error || (text ? text : `HTTP ${res.status}`);
                                errors.push(`${email}: ${errMsg}`);
                            }
                        }).catch(err => {
                            failCount++;
                            errors.push(`${email}: ${err.message}`);
                        })
                    );

                    await Promise.all(promises);
                }

                if (successCount > 0) {
                    closeInviteModal();
                    await loadPendingInvites(currentTeamId);
                }

                if (failCount === 0) {
                    alert(`æˆåŠŸå‘é€ ${successCount} ä¸ªé‚€è¯·ï¼`);
                } else {
                    alert(`å‘é€å®Œæˆã€‚\næˆåŠŸ: ${successCount}\nå¤±è´¥: ${failCount}\n\né”™è¯¯è¯¦æƒ…:\n${errors.join('\n')}`);
                }

            } catch (error) {
                alert("è¯·æ±‚å‡ºé”™: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadMembers(teamId) {
            const container = document.getElementById('membersList');
            container.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch(`/api/admin/teams/${teamId}/members`);
                const data = await response.json();
                if (data.success) {
                    displayMembers(data.members || []);
                } else {
                    container.innerHTML = `<div style="padding:10px; color:var(--danger);">åŠ è½½å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div style="padding:10px; color:var(--danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayMembers(members) {
            const container = document.getElementById('membersList');
            if (!members.length) {
                container.innerHTML = '<p style="padding:10px; text-align:center; color:#999;">æš‚æ— æˆå‘˜</p>';
                return;
            }

            let html = '<div>';
            members.forEach(member => {
                const isOwner = member.role === 'account-owner';
                const joinedAt = member.joined_at ? new Date(member.joined_at).toLocaleString('zh-CN') : '-';
                html += `
                    <div class="member-item">
                        <div class="member-info">
                            <strong>${member.email || member.name || 'Unknown'}</strong>
                            <div class="member-meta">
                                <span class="badge ${isOwner ? 'badge-warning' : ''}" style="font-size:10px;">${isOwner ? 'OWNER' : 'MEMBER'}</span>
                                åŠ å…¥: ${joinedAt}
                            </div>
                        </div>
                        ${!isOwner ? `<button onclick="kickMember('${member.user_id || member.id}', '${member.email || ''}')" class="btn btn-danger btn-sm" title="è¸¢å‡º"><i class="fa-solid fa-user-xmark"></i></button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function kickMember(userId, email) {
            if (!confirm(`ç¡®å®šè¦è¸¢å‡º ${email || 'è¯¥æˆå‘˜'} å—ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/admin/teams/${currentTeamId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email || '' })
                });
                const data = await response.json();
                if (data.success) {
                    await loadMembers(currentTeamId);
                    // refresh teams list to update count
                    loadTeams();
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function loadPendingInvites(teamId) {
            const container = document.getElementById('pendingInvitesList');
            container.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">åŠ è½½ä¸­...</div>';
            try {
                const response = await fetch(`/api/admin/teams/${teamId}/pending-invites`);
                const data = await response.json();
                if (data.success) {
                    displayPendingInvites(data.invites || []);
                } else {
                    container.innerHTML = `<div style="padding:10px; color:var(--danger);">åŠ è½½å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div style="padding:10px; color:var(--danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayPendingInvites(invites) {
            const container = document.getElementById('pendingInvitesList');
            if (!invites.length) {
                container.innerHTML = '<p style="padding:10px; text-align:center; color:#999;">æš‚æ— å¾…æ¥å—é‚€è¯·</p>';
                return;
            }

            let html = '<div>';
            invites.forEach(inv => {
                const invitedAt = inv.created_at ? new Date(inv.created_at).toLocaleString('zh-CN') : '-';
                const inviteId = inv.invite_id || inv.inviteId || inv.invitation_id || inv.id || '';
                const inviteEmail = inv.email_address || inv.email || '';
                html += `
                    <div class="member-item">
                        <div class="member-info">
                            <strong>${inviteEmail || 'Unknown'}</strong>
                            <div class="member-meta">
                                é‚€è¯·äº: ${invitedAt}
                            </div>
                        </div>
                        <button onclick="revokeInvite('${encodeURIComponent(inviteId)}','${encodeURIComponent(inviteEmail)}')" class="btn btn-danger btn-sm" title="æ’¤é”€"><i class="fa-solid fa-rotate-left"></i></button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function revokeInvite(inviteId, email) {
            const decodedInviteId = decodeURIComponent(inviteId || '');
            const decodedEmail = decodeURIComponent(email || '');
            if (!decodedInviteId) {
                alert('æ’¤é”€å¤±è´¥ï¼šç¼ºå°‘é‚€è¯· ID');
                return;
            }
            if (!confirm('ç¡®å®šè¦æ’¤é”€è¯¥é‚€è¯·å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/admin/teams/${currentTeamId}/pending-invites/${decodedInviteId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_address: decodedEmail || '', email: decodedEmail || '' })
                });
                const data = await response.json();
                if (data.success) {
                    await loadPendingInvites(currentTeamId);
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function getAccountCheckoutLink() {
            const sessionData = document.getElementById('sessionDataInput').value;
            if (!sessionData) {
                alert("è¯·å…ˆåœ¨ä¸Šæ–¹è¾“å…¥ Session JSON");
                return;
            }

            try {
                const res = await fetch("/api/admin/checkout-link", { 
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_data: sessionData })
                });
                const data = await res.json();
                if (data.success && data.url) {
                    showCheckoutModal(data.url);
                } else {
                    alert("æå–å¤±è´¥ï¼š" + (data.error || JSON.stringify(data)));
                }
            } catch (error) {
                alert("å‘ç”Ÿé”™è¯¯ï¼š" + error);
            }
        }

        function exportTeamsTxt() {
            window.location.href = '/api/admin/teams/export';
        }

        function showCheckoutModal(url) {
            document.getElementById('checkoutLinkInput').value = url;
            document.getElementById('checkoutModal').style.display = 'block';
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        function copyCheckoutLink() {
            const input = document.getElementById('checkoutLinkInput');
            const url = input.value || '';
            if (!url) return;
            navigator.clipboard.writeText(url).then(() => alert('å·²å¤åˆ¶'));
        }
        
        // Key actions
        function copyKeys(isUnlimited) {
            const keys = allKeys.filter(k => !!k.isUnlimited === isUnlimited).map(k => k.code).join('\\n');
            navigator.clipboard.writeText(keys).then(() => alert('å·²å¤åˆ¶'));
        }

        function copyKey(code) {
            if (!code) return;
            navigator.clipboard.writeText(code).then(() => alert('å·²å¤åˆ¶'));
        }

        async function deleteKey(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ— é™é‚€è¯·ç  ${code} å—ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/admin/keys/${encodeURIComponent(code)}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    await loadKeys();
                    openUnlimitedKeysModal(); // refresh view
                } else {
                    alert('é”™è¯¯: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>
