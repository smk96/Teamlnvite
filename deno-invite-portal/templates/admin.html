<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Team 管理后台</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="page admin-page">
        <div class="shell">
            <section class="hero reveal">
                <div class="hero-card">
                    <div class="hero-badge">Admin Console · Deno Edition</div>
                    <h1 class="hero-title">ChatGPT Team 管理后台</h1>
                    <p class="hero-subtitle">集中管理 Team、邀请码与自动踢人配置，所有操作实时生效。</p>
                </div>
                <div class="ornament">
                    <h3>快速指引</h3>
                    <ul>
                        <li><span>1</span>先添加 Team</li>
                        <li><span>2</span>生成邀请码</li>
                        <li><span>3</span>配置自动踢人</li>
                    </ul>
                </div>
            </section>

            <section class="main-card reveal">
                <div class="section-title">添加新 Team</div>
                <form id="addTeamForm" class="form-grid" onsubmit="addTeam(event)">
                    <div class="form-row">
                        <div class="field">
                            <label for="team_name">Team 名称 <span class="required">*</span></label>
                            <input type="text" id="team_name" name="name" placeholder="例如：Design Team" required>
                        </div>
                    </div>
                    <div class="field">
                        <label for="session_data">Session JSON <span class="required">*</span></label>
                        <textarea id="session_data" name="session_data" rows="6" placeholder='{"user": {...}, "accessToken": "..."}' required></textarea>
                    </div>
                    <div class="helper">提示：请从浏览器复制完整 session JSON。</div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">添加 Team</button>
                        <button type="reset" class="btn btn-ghost">清空</button>
                    </div>
                </form>
            </section>

            <section class="main-card reveal">
                <div class="section-title">邀请码管理</div>
                <form id="createKeyForm" class="form-grid" onsubmit="createKeys(event)">
                    <div class="form-row">
                        <div class="field">
                            <label for="key_count">生成数量</label>
                            <input type="number" id="key_count" name="count" value="1" min="1" max="20">
                        </div>
                        <div class="field checkbox-field">
                            <label class="checkbox-label">
                                <input type="checkbox" id="key_is_temp">
                                1 日试用邀请码（24 小时后自动踢出）
                            </label>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">生成邀请码</button>
                    </div>
                </form>

                <div class="actions actions-inline">
                    <button onclick="toggleKeysList()" class="btn btn-primary" id="toggleKeysBtn">查看邀请码</button>
                    <button onclick="copyAllNormalKeys()" class="btn btn-ghost">一键复制所有普通邀请码</button>
                    <button onclick="copyAllTempKeys()" class="btn btn-ghost">一键复制所有 1 日试用码</button>
                </div>

                <div id="keysList" class="list-panel" style="display: none;"></div>
            </section>

            <section class="main-card reveal">
                <div class="section-title">Auto-Kick 配置</div>
                <form id="autoKickConfigForm" class="form-grid" onsubmit="saveAutoKickConfig(event)">
                    <div class="field checkbox-field">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto_kick_enabled" name="enabled">
                            启用自动踢人
                        </label>
                    </div>
                    <div class="form-row">
                        <div class="field">
                            <label for="check_interval">检测间隔（秒）</label>
                            <input type="number" id="check_interval" name="check_interval" value="300" min="60">
                        </div>
                        <div class="field">
                            <label>运行时间段（北京时间）</label>
                            <div class="inline-fields">
                                <input type="number" id="start_hour" name="start_hour" value="0" min="0" max="23">
                                <span>时 至</span>
                                <input type="number" id="end_hour" name="end_hour" value="23" min="0" max="23">
                                <span>时</span>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary">保存配置</button>
                    </div>
                </form>
            </section>

            <section class="main-card reveal">
                <div class="section-title">Teams 列表</div>
                <div class="actions actions-inline">
                    <button onclick="toggleTeamsList()" class="btn btn-primary" id="toggleTeamsBtn">查看 Teams</button>
                </div>
                <div id="teamsList" class="list-panel" style="display: none;"></div>
            </section>

            <div class="footer">© ChatGPT Team Invite Portal · Admin</div>
        </div>
    </div>

    <script>
        let allKeys = [];
        let teamsLoaded = false;
        let keysLoaded = false;

        window.onload = function () {
            loadAutoKickConfig();
        };

        function toggleKeysList() {
            const keysList = document.getElementById('keysList');
            const toggleBtn = document.getElementById('toggleKeysBtn');
            if (keysList.style.display === 'none') {
                keysList.style.display = 'block';
                toggleBtn.textContent = '隐藏邀请码';
                if (!keysLoaded) { loadKeys(); keysLoaded = true; }
            } else {
                keysList.style.display = 'none';
                toggleBtn.textContent = '查看邀请码';
            }
        }

        function toggleTeamsList() {
            const teamsList = document.getElementById('teamsList');
            const toggleBtn = document.getElementById('toggleTeamsBtn');
            if (teamsList.style.display === 'none') {
                teamsList.style.display = 'block';
                toggleBtn.textContent = '隐藏 Teams';
                if (!teamsLoaded) { loadTeams(); teamsLoaded = true; }
            } else {
                teamsList.style.display = 'none';
                toggleBtn.textContent = '查看 Teams';
            }
        }

        async function addTeam(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/api/admin/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        session_data: formData.get('session_data')
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Team 添加成功！');
                    e.target.reset();
                    loadTeams();
                } else {
                    alert('错误: ' + data.error);
                }
            } catch (error) {
                alert('请求失败: ' + error.message);
            }
        }

        async function loadKeys() {
            try {
                const response = await fetch('/api/admin/keys');
                const data = await response.json();
                if (data.success) {
                    allKeys = data.keys;
                    displayKeys(data.keys);
                }
            } catch (error) {
                console.error('加载邀请码失败:', error);
            }
        }

        function displayKeys(keys) {
            const container = document.getElementById('keysList');
            if (!keys || keys.length === 0) {
                container.innerHTML = '<p>暂无邀请码</p>';
                return;
            }
            let html = '<div class="keys-list">';
            keys.forEach(key => {
                const keyCode = key.code;
                html += `
                    <div class="key-item">
                        <div class="key-info">
                            <div>
                                <code class="key-code">${keyCode}</code>
                                <div class="meta-row">
                                    ${key.isTemp ? '<span class="badge badge-temp">1 日试用</span>' : '<span class="badge">永久</span>'}
                                    <span class="badge">使用 ${key.usageCount} 次</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function createKeys(e) {
            e.preventDefault();
            const count = parseInt(document.getElementById('key_count').value) || 1;
            const isTemp = document.getElementById('key_is_temp').checked;
            try {
                const response = await fetch('/api/admin/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: count, is_temp: isTemp, temp_hours: isTemp ? 24 : 0 })
                });
                const data = await response.json();
                if (data.success) {
                    alert(`✅ 成功生成 ${count} 个邀请码！`);
                    loadKeys();
                } else {
                    alert('错误: ' + data.error);
                }
            } catch (error) {
                alert('请求失败: ' + error.message);
            }
        }

        async function loadAutoKickConfig() {
            try {
                const response = await fetch('/api/admin/auto-kick/config');
                const data = await response.json();
                if (data.success && data.config) {
                    document.getElementById('auto_kick_enabled').checked = data.config.enabled;
                    document.getElementById('check_interval').value = data.config.check_interval;
                    document.getElementById('start_hour').value = data.config.start_hour;
                    document.getElementById('end_hour').value = data.config.end_hour;
                }
            } catch (error) { console.error('加载配置失败:', error); }
        }

        async function saveAutoKickConfig(e) {
            e.preventDefault();
            const config = {
                enabled: document.getElementById('auto_kick_enabled').checked,
                check_interval: parseInt(document.getElementById('check_interval').value),
                start_hour: parseInt(document.getElementById('start_hour').value),
                end_hour: parseInt(document.getElementById('end_hour').value)
            };
            try {
                const response = await fetch('/api/admin/auto-kick/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                if (data.success) alert('配置保存成功！');
                else alert('错误: ' + data.error);
            } catch (error) { alert('请求失败: ' + error.message); }
        }

        async function loadTeams() {
            try {
                const response = await fetch('/api/admin/teams');
                const data = await response.json();
                if (data.success) displayTeams(data.teams);
            } catch (error) { console.error('加载 Teams 失败:', error); }
        }

        function displayTeams(teams) {
            const container = document.getElementById('teamsList');
            if (teams.length === 0) { container.innerHTML = '<p>暂无 Team</p>'; return; }
            let html = '<div class="teams-grid">';
            teams.forEach(team => {
                html += `
                    <div class="team-card">
                        <div class="team-header">
                            <h3>${team.name}</h3>
                            <span class="badge">${team.memberCount || 0}/4 人</span>
                        </div>
                        <div class="team-info">
                            <p><strong>Account ID:</strong> <code>${team.accountId}</code></p>
                            <p><strong>状态:</strong> ${team.tokenStatus}</p>
                        </div>
                        <div class="team-actions">
                            <button onclick="deleteTeam('${team.id}')" class="btn btn-danger btn-sm">删除</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function deleteTeam(teamId) {
            if (!confirm('确定要删除吗？')) return;
            try {
                const response = await fetch(`/api/admin/teams/${teamId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) { alert('Team 删除成功！'); loadTeams(); }
                else alert('错误: ' + data.error);
            } catch (error) { alert('请求失败: ' + error.message); }
        }

        function copyAllNormalKeys() {
            const keys = allKeys.filter(k => !k.isTemp).map(k => k.code).join('\n');
            navigator.clipboard.writeText(keys).then(() => alert('已复制'));
        }
        function copyAllTempKeys() {
            const keys = allKeys.filter(k => k.isTemp).map(k => k.code).join('\n');
            navigator.clipboard.writeText(keys).then(() => alert('已复制'));
        }
    </script>
</body>
</html>
